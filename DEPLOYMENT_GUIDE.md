# Deployment Guide - Anatomie Labs

## Problem Summary

Your signup/login is failing because **Netlify only deploys your frontend (React app)**, not your backend (Node.js/Express server). The authentication system requires a running backend with PostgreSQL database.

---

## Current Architecture

```
┌─────────────────────┐
│   Netlify (Frontend)│  ← Only this is deployed
│   Static React App  │
└──────────┬──────────┘
           │
           │ API calls to localhost:3001/api ❌ (fails in production)
           │
┌──────────▼──────────┐
│  Backend Server     │  ← NOT deployed (missing!)
│  - Express/Node.js  │
│  - PostgreSQL       │
│  - JWT Auth         │
│  - All API routes   │
└─────────────────────┘
```

---

## Solution: Deploy Backend Separately

### Step 1: Deploy Backend to Render

1. **Create a Render account**: https://render.com

2. **Connect your GitHub repository**

3. **Deploy using the Blueprint** (I've created `render.yaml` for you):
   - Go to Render Dashboard
   - Click "New" → "Blueprint"
   - Select your repository
   - Render will automatically detect `render.yaml` and create:
     - PostgreSQL database
     - Backend web service
     - Agents service (optional)

4. **Add Required Environment Variables** in Render Dashboard:

   Navigate to your backend service → Environment → Add:

   ```bash
   # Required for Auth
   JWT_SECRET=<auto-generated by Render>
   CLIENT_URL=https://your-app.netlify.app

   # Required API Keys (from your .env)
   OPENAI_API_KEY=sk-...
   ANTHROPIC_API_KEY=sk-ant-...
   AIRTABLE_API_KEY=...
   AIRTABLE_BASE_ID=...
   VLT_API_KEY=...

   # Cloudflare R2 Storage
   R2_ACCESS_KEY_ID=...
   R2_SECRET_ACCESS_KEY=...
   R2_BUCKET_NAME=...
   R2_ENDPOINT=...
   R2_CDN_URL=...
   ```

5. **Run Database Migrations**:

   After PostgreSQL is provisioned, connect via Render's shell and run:
   ```bash
   psql $DATABASE_URL < database/schema.sql
   ```

6. **Note your Backend URL**:
   - It will be something like: `https://anatomie-labs-backend.onrender.com`

---

### Step 2: Configure Netlify Frontend

1. **Go to Netlify Dashboard** → Your Site → Site Settings → Environment Variables

2. **Add these environment variables**:

   ```bash
   VITE_API_URL=https://anatomie-labs-backend.onrender.com/api
   VITE_AGENTS_API_URL=https://anatomie-labs-agents.onrender.com
   ```

   ⚠️ **Important**: Must use `VITE_` prefix (not `REACT_APP_`) because this app uses Vite!

3. **Also add** (for the Airtable function):
   ```bash
   AIRTABLE_API_KEY=your_key
   BASE_ID=your_base_id
   ```

4. **Trigger a new deploy**:
   - Deploys → Trigger deploy → Clear cache and deploy site

---

### Step 3: Verify Deployment

1. **Check Backend Health**:
   ```bash
   curl https://anatomie-labs-backend.onrender.com/health
   ```
   Should return: `{"status": "ok"}`

2. **Test Registration**:
   ```bash
   curl -X POST https://anatomie-labs-backend.onrender.com/api/auth/register \
     -H "Content-Type: application/json" \
     -d '{
       "email": "test@example.com",
       "password": "password123",
       "name": "Test User"
     }'
   ```

3. **Open your Netlify site** and try signing up!

---

## Architecture After Deployment

```
┌─────────────────────────┐
│   Netlify               │
│   https://your-app.     │
│   netlify.app           │
│   (Frontend)            │
└──────────┬──────────────┘
           │
           │ VITE_API_URL → API calls
           │
┌──────────▼──────────────┐
│   Render.com            │
│   https://anatomie-     │
│   labs-backend.         │
│   onrender.com          │
│   (Backend + Database)  │
└─────────────────────────┘
```

---

## Alternative: Quick Test with Local Backend

If you want to test quickly without deploying:

1. **Run backend locally**:
   ```bash
   cp .env.example .env
   # Edit .env with your API keys and database credentials
   npm install
   node server.js
   ```

2. **Use Netlify Dev** to proxy API calls:
   ```bash
   cd frontend
   netlify dev
   ```

This runs frontend on Netlify's local dev server which can proxy `/api` requests to your local backend.

---

## Troubleshooting

### "Failed to fetch" or "Network Error"

**Cause**: Frontend can't reach backend URL

**Fix**:
1. Check `VITE_API_URL` is set correctly in Netlify
2. Verify backend is running (visit health endpoint)
3. Check browser console for actual URL being called
4. Ensure backend `CLIENT_URL` includes your Netlify URL for CORS

### "Invalid credentials" on signup

**Cause**: Backend is working but database isn't set up

**Fix**:
1. Connect to Render PostgreSQL
2. Run database migrations from `/database/schema.sql`
3. Check Render logs for database errors

### Backend returns 500 errors

**Cause**: Missing environment variables

**Fix**:
1. Check Render logs: Dashboard → Your Service → Logs
2. Add missing environment variables
3. Restart the service

---

## Cost Estimate

### Free Tier (for testing):
- **Netlify**: Free (100GB bandwidth/month)
- **Render**: Free PostgreSQL + Free web service (sleeps after 15min inactivity)
- **Total**: $0/month (with sleep delays)

### Paid Tier (for production):
- **Netlify**: Free tier is usually enough
- **Render**:
  - PostgreSQL: $7/month (always-on)
  - Web service: $7/month (always-on)
- **Total**: ~$14/month

---

## Next Steps

1. ✅ Deploy backend to Render using `render.yaml`
2. ✅ Add environment variables in Render dashboard
3. ✅ Run database migrations
4. ✅ Configure Netlify environment variables with backend URL
5. ✅ Test signup/login on your deployed site

---

## Files I've Created/Updated

1. ✅ `render.yaml` - Render Blueprint for automatic deployment
2. ✅ `netlify.toml` - Fixed publish directory (dist) and added env var docs
3. ✅ `DEPLOYMENT_GUIDE.md` - This comprehensive guide

---

## Need Help?

If you run into issues:
1. Check Render logs for backend errors
2. Check browser console for frontend errors
3. Verify all environment variables are set correctly
4. Make sure database migrations ran successfully

The most common issue is forgetting to set `VITE_API_URL` in Netlify or `CLIENT_URL` in Render.
